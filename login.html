<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Grocery Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        .error-message {
            color: red;
            font-size: 0.8rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="card p-4 shadow-lg" style="width: 350px;">
        <h3 class="text-center mb-4">Login</h3>
        
        <form id="loginForm">
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa fa-user"></i></span>
                    <input type="text" id="username" class="form-control" placeholder="Enter your username" required>
                </div>
                <div id="usernameError" class="error-message"></div>
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa fa-lock"></i></span>
                    <input type="password" id="password" class="form-control" placeholder="Enter your password" required>
                </div>
                <div id="passwordError" class="error-message"></div>
            </div>

            <div id="generalError" class="error-message text-center mb-3"></div>

            <div class="d-grid">
                <button type="submit" class="btn btn-primary">Login</button>
            </div>

            <p class="text-center mt-3">Don't have an account? 
                <a href="register.html" class="text-decoration-none">Register</a>
            </p>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.getElementById("loginForm").addEventListener("submit", async function(event) {
    event.preventDefault();
    
    // Reset error messages
    document.getElementById("usernameError").textContent = '';
    document.getElementById("passwordError").textContent = '';
    document.getElementById("generalError").textContent = '';

    // Collect form values
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();

    // Validation
    let isValid = true;

    if (!username) {
        document.getElementById("usernameError").textContent = 'Username is required';
        isValid = false;
    }

    if (!password) {
        document.getElementById("passwordError").textContent = 'Password is required';
        isValid = false;
    }

    // Stop if validation fails
    if (!isValid) return;

    try {
        const response = await fetch("http://localhost:3000/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
        });

        // Log full response for debugging
        console.log('Full Response:', response);

        // Check if response is not successful
        if (!response.ok) {
            try {
                const errorResult = await response.json();
                console.error('Error Response:', errorResult);

                // Display specific error messages
                if (errorResult.message) {
                    document.getElementById("generalError").textContent = errorResult.message;
                } else {
                    document.getElementById("generalError").textContent = `Error: ${response.status} ${response.statusText}`;
                }
                return;
            } catch (parseError) {
                console.error('Error parsing error response:', parseError);
                document.getElementById("generalError").textContent = 'An unexpected error occurred';
                return;
            }
        }

        // Parse successful response
        const result = await response.json();

        // Show success message and redirect
        alert("Login successful!");
        window.location.href = "userdashboard.html";

    } catch (error) {
        // Handle network or unexpected errors
        console.error("Detailed Error:", error);
        
        if (error instanceof TypeError) {
            document.getElementById("generalError").textContent = 'Network error. Please check your connection.';
        } else {
            document.getElementById("generalError").textContent = 'Something went wrong. Please try again later.';
        }
    }
});
</script>

</body>
</html>